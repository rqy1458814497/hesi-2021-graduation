\usepackage{geometry}
\geometry{paperwidth=210mm,paperheight=297mm,outer=30mm,inner=32mm,top=38mm,bottom=32mm}

% fonts & unicode
\usepackage[PunctStyle=kaiming]{xeCJK}
\usepackage{amsmath}
\usepackage{unicode-math}
\setmainfont[Path=fonts/,Extension=.otf,UprightFont=*-Regular,BoldFont=*-Bold,ItalicFont=*-Italic,BoldItalicFont=*-BoldItalic]{XITS}
%\setsansfont[Path=fonts/,Scale=.95,Extension=.ttf,UprightFont=*-Regular]{NotoSans}
\setsansfont[Path=fonts/,Scale=.95,Extension=.ttf]{Helvetica}
\setmonofont[Path=fonts/,Scale=.9,Extension=.otf,UprightFont=*-Regular,BoldFont=*-Bold]{FiraMono}
\setCJKmainfont[Path=fonts/,Extension=.ttf,BoldFont=fzhtk]{fzssk}
\setCJKsansfont[Path=fonts/,Scale=.95,Extension=.ttf]{fzhtk}
\setCJKmonofont[Path=fonts/,Scale=.95,Extension=.ttf]{fzhtk}
\newCJKfontfamily\fangsong[Path=fonts/,Extension=.ttf]{fzfsk}
\newCJKfontfamily\lishu[Path=fonts/,Extension=.ttf]{fzlsk}
\setmathfont[Path=fonts/,BoldFont=XITSMath-Bold.otf]{XITSMath-Regular.otf}
\setmathfont[Path=fonts/,range={frak,bffrak}]{latinmodern-math.otf}
\setmathfont[Path=fonts/,Scale=.95,BoldFont=LatoMath.otf,version=sf]{LatoMath.otf}
\setmathfont[Path=fonts/,Scale=.95,BoldFont=LatoMath.otf,range={bb,sfup->up,sfit->it,bfsfup->bfup,bfsfit->bfit}]{LatoMath.otf}
\setmathfont[Path=fonts/,BoldFont=STIX2Math-Bold.otf,range={\int,\sum,\prod,\coprod,\bigoplus,\bigotimes,\oint,\intbar}]{STIX2Math.otf}

\Umathcode`/ = "0 "0 "2215    % / -> U+2215 division slash

% patch 'text math' math alphabets in bold math
\setmathfontface\mathrm[Path=fonts/,version=bold]{XITS-Bold.otf}
\setmathfontface\mathit[Path=fonts/,version=bold]{XITS-BoldItalic.otf}
\setmathfontface\mathbf[Path=fonts/,version=bold]{XITS-Bold.otf}
\setmathfontface\mathtt[Path=fonts/,Scale=.9,version=bold]{FiraMono-Bold.otf}
\setmathfontface\mathrm[Path=fonts/,Scale=MatchUppercase,version=sf]{Lato-Regular.ttf}
\setmathfontface\mathit[Path=fonts/,Scale=MatchUppercase,version=sf]{Lato-Italic.ttf}
\setmathfontface\mathbf[Path=fonts/,Scale=MatchUppercase,version=sf]{Lato-Bold.ttf}
\setmathfontface\mathtt[Path=fonts/,Scale=.9,version=sf]{FiraMono-Regular.otf}

% title & abstract
\def\title#1\author#2{\headertitle{#1}\vspace*{0mm}\begin{center}{\sf\LARGE#1\par}\vspace{10mm}{\large#2}\end{center}\vspace{10mm}}
\def\headertitle#1{\def\theheadertitle{#1}}

\makeatletter
\let\endabstract@orig\endabstract
\def\endabstract{\endabstract@orig\vspace{5mm}}
\makeatother

% section titles
\usepackage{titlesec}
\titleformat*{\section}{\centering\Large\sffamily\mathversion{sf}}
\titleformat*{\subsection}{\large\sffamily\mathversion{sf}}
\titlespacing*{\section}{0pt}{40pt}{20pt}
\titlespacing*{\subsection}{0pt}{25pt}{12pt}

% spacing
\AtBeginDocument{
    \hfuzz=2pt
    \emergencystretch 2em
    \setlength{\belowdisplayshortskip}{\belowdisplayskip}
}

% environments
\usepackage{amsthm}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{remark}[theorem]{Remark}
\theoremstyle{plain}

\def\qedsymbol{$â—»$}
\def\thmqedhere{\pushQED{\qed}\qedhere\popQED}

\numberwithin{equation}{theorem}

% renew theorem: https://tex.stackexchange.com/q/103013/
\makeatletter
\def\renewtheorem#1{%
  \expandafter\let\csname#1\endcsname\relax
  \expandafter\let\csname c@#1\endcsname\relax
  \gdef\renewtheorem@envname{#1}
  \renewtheorem@secpar
}
\def\renewtheorem@secpar{\@ifnextchar[{\renewtheorem@numberedlike}{\renewtheorem@nonumberedlike}}
\def\renewtheorem@numberedlike[#1]#2{\newtheorem{\renewtheorem@envname}[#1]{#2}}
\def\renewtheorem@nonumberedlike#1{  
\def\renewtheorem@caption{#1}
\edef\renewtheorem@nowithin{\noexpand\newtheorem{\renewtheorem@envname}{\renewtheorem@caption}}
\renewtheorem@thirdpar
}
\def\renewtheorem@thirdpar{\@ifnextchar[{\renewtheorem@within}{\renewtheorem@nowithin}}
\def\renewtheorem@within[#1]{\renewtheorem@nowithin[#1]}
\makeatother

% ref & biblatex
\usepackage[colorlinks,allcolors=black,bookmarksnumbered,linktoc=all]{hyperref}

\def\thesection{\arabic{section}\texorpdfstring{}{.}} % pdf bookmark numbering
% \setcounter{secnumdepth}{1} % suppress subsection numbering
\setcounter{tocdepth}{2} % suppress subsubsection in toc

\usepackage[style=alphabetic,sorting=anyvt,useprefix=true]{biblatex}
\usepackage{xpatch}
\renewcommand*{\bibfont}{\small}
\DeclareFieldFormat[article]{volume}{\mkbibbold{#1}}
\DeclareFieldFormat[book,inbook]{number}{\mkbibbold{#1}}
\DeclareFieldFormat[article]{number}{(#1)}
\DeclareFieldFormat*{year}{(#1)}
\DeclareFieldFormat{pages}{#1}
\renewbibmacro{in:}{}
\renewbibmacro*{volume+number+eid}{%
  \printfield{volume}%
  \setunit*{\addnbspace}% originally: \setunit*{\adddot}
  \printfield{number}%
  \setunit{\addcomma\space}%
  \printfield{eid}%
}
\xapptobibmacro{author/editor+others/translator+others}{%
  \setunit{\space}%
  \printfield{year}%
  \clearfield{year}%
}{}{}
\xapptobibmacro{author/translator+others}{%
  \setunit{\space}%
  \printfield{year}%
  \clearfield{year}%
}{}{}
\renewbibmacro*{issue+date}{%
  \printfield{issue}%
  \newunit%
}
\AtBeginBibliography{
  \DeclareFieldFormat{labelalpha}{#1}
  \DeclareFieldFormat{extraalpha}{\mknumalph{#1}}
}
\AtEveryBibitem{
  \ifentrytype{online}{%
    \clearfield{year}%
  }{}
}

% tikz
\usepackage{tikz}
\usepackage{tikz-cd}
\usetikzlibrary{
    decorations.pathreplacing,
    decorations.markings
}
\tikzcdset{
  arrow style=tikz,
  arrows={/tikz/line width=.5pt},
  diagrams={>={Straight Barb[scale=0.8]}},
  nodes={inner xsep=3pt,inner ysep=3pt}
}

% thesis
\usepackage{setspace}
\setstretch{1.38}

\usepackage{emptypage}

\numberwithin{figure}{section}
